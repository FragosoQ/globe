<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Novo Dado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); padding: 32px; width: 100%; max-width: 480px; }
        .input-group label { font-weight: 500; color: #374151; margin-bottom: 4px; display: block; }
        .input-group input { border: 1px solid #d1d5db; border-radius: 6px; padding: 10px 14px; width: 100%; transition: border-color 0.2s; }
        .input-group input:focus { border-color: #4f46e5; outline: none; box-shadow: 0 0 0 1px #4f46e5; }
        .btn-primary { background-color: #4f46e5; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .message-box { padding: 12px; margin-top: 16px; border-radius: 6px; font-weight: 500; }
        .success { background-color: #d1fae5; color: #065f46; }
        .error { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <div class="card">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Adicionar Nova Rota</h1>
        <form id="routeForm" class="space-y-4">
            <div class="input-group">
                <label for="code">Código IATA (3 letras)</label>
                <input type="text" id="code" name="code" maxlength="3" required placeholder="Ex: GUA">
            </div>

            <div class="input-group">
                <label for="color">Cor (Hex ou RGBA)</label>
                <input type="text" id="color" name="color" required placeholder="Ex: #50B6E8 ou rgba(255,0,0,0.5)">
            </div>

            <div class="flex space-x-4">
                <div class="input-group flex-1">
                    <label for="endLat">Lat. Destino</label>
                    <input type="number" id="endLat" name="endLat" step="any" required placeholder="Ex: 14.6349">
                </div>
                <div class="input-group flex-1">
                    <label for="endLng">Long. Destino</label>
                    <input type="number" id="endLng" name="endLng" step="any" required placeholder="Ex: -90.5069">
                </div>
            </div>

            <div class="text-sm text-gray-500 pt-2">
                *Lat. e Long. de partida: 38.7223 / -9.1393 (fixos no código)
            </div>

            <button type="submit" id="submitButton" class="btn-primary w-full mt-6">Adicionar Rota</button>

            <div id="messageBox" class="message-box hidden"></div>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configurações Globais
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Dados fixos da rota de partida
        const START_LAT = 38.7223;
        const START_LNG = -9.1393;

        let db, auth;
        let isAuthReady = false;

        const form = document.getElementById('routeForm');
        const messageBox = document.getElementById('messageBox');
        const submitButton = document.getElementById('submitButton');

        function showMessage(text, type) {
            messageBox.textContent = text;
            messageBox.className = `message-box ${type}`;
            messageBox.classList.remove('hidden');
        }

        // Função de Inicialização do Firebase
        async function initializeFirebase() {
            try {
                // setLogLevel('Debug'); // Ativar logs para debug
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Autenticação
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        submitButton.disabled = false;
                        submitButton.textContent = 'Adicionar Rota';
                    } else {
                        isAuthReady = false;
                        showMessage('Erro de autenticação. Tente novamente.', 'error');
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
                showMessage('Erro crítico ao carregar o aplicativo. Verifique o console.', 'error');
                submitButton.disabled = true;
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) {
                showMessage('Aguarde a autenticação do sistema.', 'error');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            messageBox.classList.add('hidden');

            // 1. Coleta e sanitização dos dados
            const formData = new FormData(form);
            const data = {
                code: (formData.get('code') || '').toUpperCase().trim(),
                color: (formData.get('color') || '').trim(),
                endLat: parseFloat(formData.get('endLat')),
                endLng: parseFloat(formData.get('endLng')),
                startLat: START_LAT,
                startLng: START_LNG,
                timestamp: serverTimestamp()
            };

            // 2. Validação simples
            if (data.code.length !== 3 || isNaN(data.endLat) || isNaN(data.endLng)) {
                showMessage('Por favor, preencha todos os campos corretamente (Código IATA deve ter 3 letras).', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Adicionar Rota';
                return;
            }

            // 3. Envio para o Firestore
            try {
                const collectionPath = `/artifacts/${appId}/public/data/routes`;
                await addDoc(collection(db, collectionPath), data);
                
                showMessage(`Rota ${data.code} adicionada com sucesso!`, 'success');
                form.reset(); // Limpa o formulário
            } catch (error) {
                console.error("Erro ao adicionar documento:", error);
                showMessage(`Erro ao salvar: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Adicionar Rota';
            }
        });

        // Inicia o processo
        initializeFirebase();
    </script>
</body>
</html>
