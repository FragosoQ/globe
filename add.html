const SHEET_ID = '1e7iYEB6OH00aT5hqE6pi6qmafitHq8BNvHt7Fo0wW_8'; // O seu ID de Sheet
const SHEET_NAME = 'DATA1'; // Ajuste se o nome da sua folha for diferente

/**
 * Lida com requisições HTTP POST enviadas pelo formulário.
 * Recebe os dados e anexa uma nova linha à Google Sheet.
 * * @param {Object} e - Objeto de evento que contém os parâmetros de requisição.
 * @returns {GoogleAppsScript.Content.TextOutput} Resposta de sucesso.
 */
function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000); // Tenta bloquear por 10 segundos para evitar escritas simultâneas

  try {
    // Abre a folha de cálculo e seleciona a folha
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    
    // Verifica se os dados POST existem e se são do tipo 'application/x-www-form-urlencoded'
    if (e.postData && e.postData.type === "application/x-www-form-urlencoded") {
      const params = e.parameter;
      
      // Validação básica se os campos cruciais estão presentes
      if (params.code && params.color && params.endLat && params.endLng) {
        
        // Os valores são inseridos na ordem das colunas A, B, C, D
        const newRow = [
          params.code,      // Coluna A: Código IATA
          params.color,     // Coluna B: Cor
          params.endLat,    // Coluna C: Lat. Destino
          params.endLng,    // Coluna D: Long. Destino
          // Note: As coordenadas de partida (E e F) não são escritas
          // pois são constantes e podem ser calculadas/adicionadas à tabela de leitura
        ];
        
        // Anexa a nova linha à folha
        sheet.appendRow(newRow);

        // Retorna uma resposta de sucesso (embora o cliente use 'no-cors' e a ignore)
        return ContentService
          .createTextOutput(JSON.stringify({ result: 'success', message: `Rota ${params.code} adicionada.` }))
          .setMimeType(ContentService.MimeType.JSON);
          
      } else {
        // Retorno de erro se faltarem parâmetros
        return ContentService
          .createTextOutput(JSON.stringify({ result: 'error', message: 'Faltam parâmetros obrigatórios.' }))
          .setMimeType(ContentService.MimeType.JSON);
      }
    } else {
      // Retorno de erro se o tipo de requisição não for o esperado
      return ContentService
        .createTextOutput(JSON.stringify({ result: 'error', message: 'Requisição inválida (apenas POST permitido).' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    Logger.log("Erro ao processar doPost: " + error.toString());
    // Retorno de erro em caso de falha de execução do script
    return ContentService
      .createTextOutput(JSON.stringify({ result: 'error', message: `Erro interno do Script: ${error.toString()}` }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    // Garante que o lock é liberado
    lock.releaseLock();
  }
}
